name: Deploy to Hostinger VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Debug values
        run: |
          echo "VPS_HOST is ${{ vars.VPS_HOST }}"
          echo "VPS_DEPLOY_KEY is ${{ secrets.VPS_DEPLOY_KEY }}"

      - name: Set up SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_DEPLOY_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ vars.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to Hostinger VPS
        env:
          SSH_USER: ${{ vars.VPS_USER }}
          SSH_HOST: ${{ vars.VPS_HOST }}
        run: |
          ssh $SSH_USER@$SSH_HOST bash -s << 'EOF'
            set -e  # stop on errors

            echo "ðŸš€ Connected to server"
            cd /ethenugu/landing-page-api || exit 1

            echo "ðŸ“¥ Pulling latest code..."
            git pull

            echo "ðŸ“¦ Installing dependencies..."
            npm ci --omit=dev

            echo "â™»ï¸ Restarting app with PM2..."
            command -v pm2 >/dev/null 2>&1 || export PATH=$HOME/.npm-global/bin:$PATH
            pm2 restart ethenugu-landing-page-api || pm2 start npm --name ethenugu-landing-page-api -- start

            echo "âœ… Done!"
          EOF
